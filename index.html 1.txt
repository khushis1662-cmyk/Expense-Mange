<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Divinam Structuray - Expense Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- PDF Export Libraries (jsPDF and autoTable plugin) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* Light background */
        }
        .text-primary { color: #003366; } /* Deep Corporate Blue */
        .bg-primary { background-color: #003366; }
        .border-accent { border-color: #FFD700; } /* Gold Accent */
    </style>
</head>
<body>

    <!-- Main Container -->
    <div id="app" class="min-h-screen p-4 sm:p-8">
        <!-- Header -->
        <header class="mb-8 p-6 bg-white shadow-lg rounded-2xl border-t-4 border-primary">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-primary flex items-center">
                <span class="mr-3">Divinam Structuray</span>
                <span class="text-2xl text-accent font-light">Employee Expense Management</span>
            </h1>
            <p id="auth-status" class="text-sm text-gray-500 mt-2">Loading user session...</p>
            <p id="user-id-display" class="text-xs text-gray-400 mt-1 truncate">User ID: N/A</p>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Column 1: Add New Expense -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 shadow-xl rounded-2xl sticky top-8">
                    <h2 class="text-xl font-bold text-primary mb-4 border-b pb-2">Log New Expense</h2>
                    
                    <form id="expense-form" class="space-y-4">
                        
                        <!-- NEW: Employee Name/ID -->
                        <div>
                            <label for="employee-name" class="block text-sm font-medium text-gray-700">Employee Name/ID (Required)</label>
                            <input type="text" id="employee-name" required placeholder="e.g., John Doe or E1001" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 border">
                            <p class="text-xs text-gray-500 mt-1">Use a consistent name for filtering.</p>
                        </div>
                        
                        <!-- Expense Type -->
                        <div>
                            <label for="type" class="block text-sm font-medium text-gray-700">Category</label>
                            <select id="type" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 border">
                                <option value="" disabled selected>Select Category</option>
                                <option value="Travel">‚úàÔ∏è Travel</option>
                                <option value="Food">üçî Food / Meals</option>
                                <option value="Fuel">‚õΩ Fuel / Mileage</option>
                                <option value="Other">üíº Other Admin</option>
                            </select>
                        </div>

                        <!-- Date -->
                        <div>
                            <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="date" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 border">
                        </div>
                        
                        <!-- Cash/Advance Received (Now always visible) -->
                        <div id="advance-group" class="border-l-4 border-green-500 p-2 bg-green-50 rounded-lg">
                            <label for="advance" class="block text-sm font-medium text-gray-800">Cash/Advance Received (INR)</label>
                            <input type="number" id="advance" min="0" step="0.01" value="0.00" placeholder="e.g., 500.00 cash received from company" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 border">
                            <p class="text-xs text-green-700 mt-1">Cash or advance received from the company for this expense.</p>
                        </div>

                        <!-- Amount -->
                        <div>
                            <label for="amount" class="block text-sm font-medium text-gray-700">Amount Spent (INR)</label>
                            <input type="number" id="amount" required min="0.01" step="0.01" placeholder="e.g., 450.75" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 border">
                        </div>

                        <!-- Description -->
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700">Description / Purpose</label>
                            <textarea id="description" required rows="3" placeholder="Brief reason for the expense (e.g., Client meeting lunch)" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 border"></textarea>
                        </div>
                        
                        <button type="submit" id="submit-btn" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-primary hover:bg-opacity-90 transition duration-150 ease-in-out flex items-center justify-center">
                            <span data-lucide="plus-circle" class="w-5 h-5 mr-2"></span>
                            Add Expense
                        </button>
                    </form>
                    <p id="error-message" class="text-red-500 text-sm mt-3 hidden"></p>
                </div>
            </div>

            <!-- Column 2 & 3: Totals and Expense List -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- Summary/Totals Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    
                    <!-- Total Expenses Card -->
                    <div class="bg-white p-6 rounded-2xl shadow-xl border-l-4 border-red-500">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-500">Total Spent</span>
                            <span data-lucide="wallet" class="w-6 h-6 text-red-500"></span>
                        </div>
                        <p id="total-expenses" class="text-3xl font-extrabold mt-1 text-primary">‚Çπ0.00</p>
                        <p class="text-xs text-gray-400 mt-1">Sum of all amounts spent (filtered).</p>
                    </div>
                    
                    <!-- Net Balance Card -->
                    <div id="net-balance-card" class="bg-white p-6 rounded-2xl shadow-xl border-l-4">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-500">Net Balance</span>
                            <span data-lucide="calculator" class="w-6 h-6" id="net-balance-icon"></span>
                        </div>
                        <p id="net-balance" class="text-3xl font-extrabold mt-1">‚Çπ0.00</p>
                        <p id="net-balance-status" class="text-xs mt-1 text-gray-400">Total Spent - Total Advance (filtered).</p>
                    </div>

                    <!-- Total Entries Card -->
                    <div class="bg-white p-6 rounded-2xl shadow-xl border-l-4 border-yellow-500">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-500">Number of Entries</span>
                            <span data-lucide="list-checks" class="w-6 h-6 text-yellow-500"></span>
                        </div>
                        <p id="total-entries" class="text-3xl font-extrabold mt-1 text-primary">0</p>
                        <p class="text-xs text-gray-400 mt-1">Total transactions logged (filtered).</p>
                    </div>
                </div>

                <!-- Export Buttons -->
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="export-csv-btn" class="flex-1 py-3 px-4 rounded-lg shadow-md text-sm font-medium text-primary border border-primary bg-white hover:bg-gray-50 transition duration-150 ease-in-out flex items-center justify-center">
                        <span data-lucide="file-text" class="w-5 h-5 mr-2"></span>
                        Export to CSV (Excel)
                    </button>
                    <button id="export-pdf-btn" class="flex-1 py-3 px-4 rounded-lg shadow-md text-sm font-medium text-white bg-red-600 border border-red-600 hover:bg-red-700 transition duration-150 ease-in-out flex items-center justify-center">
                        <span data-lucide="file-text" class="w-5 h-5 mr-2"></span>
                        Export to PDF
                    </button>
                </div>

                <!-- Employee Filter -->
                <div class="bg-white p-6 shadow-xl rounded-2xl">
                    <h2 class="text-xl font-bold text-primary mb-4 border-b pb-2 flex items-center">
                        <span data-lucide="filter" class="w-6 h-6 mr-2"></span> Filter Expenses
                    </h2>
                    <div class="flex items-center space-x-4">
                        <label for="employee-filter" class="text-sm font-medium text-gray-700 whitespace-nowrap">Filter by Employee Name:</label>
                        <input type="text" id="employee-filter" placeholder="Enter name to filter (e.g., John Doe)" class="flex-grow rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 p-2 border">
                        <button id="clear-filter-btn" class="text-gray-500 hover:text-red-600 transition" title="Clear Filter">
                            <span data-lucide="x-circle" class="w-6 h-6"></span>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Filter affects all summaries, lists, and exports below.</p>
                </div>

                <!-- Monthly Expense Summary -->
                <div class="bg-white p-6 shadow-xl rounded-2xl">
                    <h2 class="text-xl font-bold text-primary mb-4 border-b pb-2">Monthly Expense Summary (Filtered)</h2>
                    <div id="monthly-summary-body" class="space-y-4">
                        <!-- Monthly summaries will be inserted here by JavaScript -->
                        <p class="text-gray-500 text-sm italic">Calculating monthly breakdown...</p>
                    </div>
                </div>

                <!-- Expense List Table -->
                <div class="bg-white p-6 shadow-xl rounded-2xl">
                    <h2 class="text-xl font-bold text-primary mb-4 border-b pb-2">Expense History (All Company Entries)</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Spent (‚Çπ)</th>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Advance (‚Çπ)</th>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="expense-list-body" class="bg-white divide-y divide-gray-200">
                                <!-- Expenses will be inserted here by JavaScript -->
                                <tr>
                                    <td colspan="7" class="text-center py-4 text-gray-500">Loading expenses...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal (hidden by default) -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 class="text-lg font-bold text-red-600 mb-4">Confirm Deletion</h3>
            <p class="text-gray-700 mb-6">Are you sure you want to delete this expense? This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition">Cancel</button>
                <button id="confirm-delete" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition">Delete</button>
            </div>
        </div>
    </div>

    <!-- Firebase Imports and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level to debug for console output
        setLogLevel('Debug');

        // --- Global Variables Provided by Canvas Environment ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let allExpenses = []; // Master storage for current expense data fetched from Firestore

        // --- DOM Elements ---
        const expenseForm = document.getElementById('expense-form');
        const employeeNameInput = document.getElementById('employee-name');
        const employeeFilterInput = document.getElementById('employee-filter');
        const clearFilterBtn = document.getElementById('clear-filter-btn');
        const expenseListBody = document.getElementById('expense-list-body');
        const totalExpensesEl = document.getElementById('total-expenses');
        const totalEntriesEl = document.getElementById('total-entries');
        const authStatusEl = document.getElementById('auth-status');
        const userIdDisplayEl = document.getElementById('user-id-display');
        const errorMessageEl = document.getElementById('error-message');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        const submitBtn = document.getElementById('submit-btn');
        const monthlySummaryBodyEl = document.getElementById('monthly-summary-body');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const exportPdfBtn = document.getElementById('export-pdf-btn');

        // Elements for Advance Tracking
        const typeSelect = document.getElementById('type');
        const netBalanceEl = document.getElementById('net-balance');
        const netBalanceStatusEl = document.getElementById('net-balance-status');
        const netBalanceCardEl = document.getElementById('net-balance-card');
        const netBalanceIconEl = document.getElementById('net-balance-icon');


        // --- Utility Functions ---

        /**
         * Safely formats a number to INR currency string.
         * @param {number} amount 
         * @returns {string}
         */
        const formatCurrency = (amount) => {
            const absoluteAmount = Math.abs(amount);
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                maximumFractionDigits: 2,
            }).format(absoluteAmount);
        };

        // --- Firebase Initialization and Authentication ---

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase config is missing or empty.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. Authenticate
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    authStatusEl.textContent = 'Session loaded. Welcome Admin!';
                } else {
                    await signInAnonymously(auth);
                    authStatusEl.textContent = 'Signed in anonymously. Data is shared.';
                }

                // 2. Set up Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplayEl.textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        // Start listening for data once auth is ready
                        listenForExpenses();
                    } else {
                        userId = null;
                        isAuthReady = false;
                        userIdDisplayEl.textContent = 'User ID: N/A';
                        authStatusEl.textContent = 'Authentication failed. Please check setup.';
                        expenseListBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-red-500">Authentication failed. Cannot load data.</td></tr>`;
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                authStatusEl.textContent = `Error: ${error.message}`;
                errorMessageEl.textContent = `System Error: ${error.message}. Check console for details.`;
                errorMessageEl.classList.remove('hidden');
            }
        }

        // --- Firestore Operations ---

        /**
         * Gets the path to the SHARED public expenses collection.
         */
        const getExpensesCollectionPath = () => {
             // Shared data path: /artifacts/{appId}/public/data/{collection_name}
             return `artifacts/${appId}/public/data/expenses`;
        };

        /**
         * Adds a new expense document to Firestore.
         * @param {object} expenseData 
         */
        async function addExpense(expenseData) {
            try {
                if (!isAuthReady || !userId) {
                    throw new Error("User not authenticated or auth still loading.");
                }
                
                const expensesCollection = collection(db, getExpensesCollectionPath());
                await addDoc(expensesCollection, {
                    ...expenseData,
                    amount: parseFloat(expenseData.amount), // Expense amount (spent)
                    advance: parseFloat(expenseData.advance || 0), // Advance amount (0 if not provided)
                    createdAt: serverTimestamp()
                });

                errorMessageEl.classList.add('hidden');
                expenseForm.reset();
                typeSelect.value = ""; // Reset select manually
            } catch (error) {
                console.error("Error adding document: ", error);
                errorMessageEl.textContent = `Failed to add expense: ${error.message}`;
                errorMessageEl.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span data-lucide="plus-circle" class="w-5 h-5 mr-2"></span> Add Expense';
                // Re-render icons after adding content/updating innerHTML
                lucide.createIcons(); 
            }
        }
        
        /**
         * Deletes an expense document from Firestore.
         * @param {string} expenseId 
         */
        async function deleteExpense(expenseId) {
            try {
                if (!isAuthReady || !userId) {
                    throw new Error("User not authenticated or auth still loading.");
                }
                
                const expenseDocRef = doc(db, getExpensesCollectionPath(), expenseId);
                await deleteDoc(expenseDocRef);
                errorMessageEl.classList.add('hidden');
            } catch (error) {
                console.error("Error deleting document: ", error);
                errorMessageEl.textContent = `Failed to delete expense: ${error.message}`;
                errorMessageEl.classList.remove('hidden');
            }
        }

        /**
         * Sets up a real-time listener for the expenses collection.
         */
        function listenForExpenses() {
            if (!isAuthReady || !userId) return;

            const expensesCollectionRef = collection(db, getExpensesCollectionPath());
            const q = query(expensesCollectionRef);
            
            // onSnapshot provides real-time updates whenever data changes
            onSnapshot(q, (snapshot) => {
                const expenses = [];
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const expense = {
                        id: doc.id,
                        ...data,
                        amount: data.amount || 0,
                        advance: data.advance || 0, 
                        // Extract YYYY-MM for grouping
                        month: data.date ? data.date.substring(0, 7) : 'Unknown', 
                    };
                    expenses.push(expense);
                });

                // Store and Sort the master list of expenses by date (newest first)
                allExpenses = expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

                // Re-render the UI based on the current filter
                applyFilterAndRender();

            }, (error) => {
                console.error("Error fetching documents: ", error);
                expenseListBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-red-500">Failed to load expenses. ${error.message}</td></tr>`;
            });
        }
        
        // --- Filtering and Rendering Logic ---

        /**
         * Filters expenses based on the employee filter input and triggers rendering.
         */
        function applyFilterAndRender() {
            const filterValue = employeeFilterInput.value.trim().toLowerCase();
            
            const filteredExpenses = allExpenses.filter(expense => {
                if (!filterValue) return true; // Show all if filter is empty
                
                // Case-insensitive partial match on employee name
                return expense.employeeName && expense.employeeName.toLowerCase().includes(filterValue);
            });

            // Calculate totals for the FILTERED set
            let totalAmount = 0;
            let totalAdvances = 0; 
            let entryCount = filteredExpenses.length;
            const monthlyTotals = {};
            
            filteredExpenses.forEach(expense => {
                totalAmount += expense.amount;
                totalAdvances += expense.advance; 

                if (expense.month !== 'Unknown') {
                    monthlyTotals[expense.month] = (monthlyTotals[expense.month] || 0) + expense.amount;
                }
            });

            // Update UI components
            renderExpenses(filteredExpenses); // Render the list
            updateTotals(totalAmount, totalAdvances, entryCount); // Update summary cards
            renderMonthlySummary(monthlyTotals); // Update monthly summary
        }


        // --- Export Functions ---

        /**
         * Converts the expense array to CSV format and triggers a download.
         * @param {Array<object>} data - The expense data array (should be the filtered set).
         */
        function exportToCsv(data) {
            if (data.length === 0) {
                alert("No expense data to export (check filter settings).");
                return;
            }

            const header = ["EmployeeName", "Date", "Category", "Description", "AmountSpent(INR)", "AdvanceReceived(INR)", "NetAmount(Spent-Advance)"];
            
            const csvRows = [];
            csvRows.push(header.join(',')); // Add header row

            data.forEach(expense => {
                const netAmount = (expense.amount - expense.advance).toFixed(2);
                const row = [
                    expense.employeeName || 'N/A',
                    expense.date,
                    expense.type,
                    `"${expense.description.replace(/"/g, '""')}"`, // Handle commas/quotes in description
                    expense.amount.toFixed(2),
                    expense.advance.toFixed(2),
                    netAmount
                ];
                csvRows.push(row.join(','));
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            
            const filter = employeeFilterInput.value.trim() ? `_${employeeFilterInput.value.trim().replace(/\s/g, '-')}` : '_all';
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `expense_report${filter}_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        /**
         * Generates a PDF report using jsPDF and autoTable.
         * @param {Array<object>} data - The expense data array (should be the filtered set).
         */
        function exportToPdf(data) {
            if (data.length === 0) {
                alert("No expense data to export (check filter settings).");
                return;
            }

            // window.jsPDF is available via the CDN import
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const netBalanceAmount = parseFloat(document.getElementById('net-balance').textContent.replace(/[^\d.-]/g, ''));
            const netBalanceStatus = document.getElementById('net-balance-status').textContent;
            
            // Header
            doc.setFontSize(18);
            doc.text("Divinam Structuray - Expense Report", 14, 20);
            
            doc.setFontSize(10);
            doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 27);
            doc.text(`User ID: ${userId}`, 14, 32);
            doc.text(`Filter Used: ${employeeFilterInput.value.trim() || 'All Employees'}`, 14, 37);

            // Summary Table
            doc.autoTable({
                startY: 45,
                head: [['Total Spent (INR)', 'Total Advance (INR)', 'Net Balance (INR)']],
                body: [[
                    totalExpensesEl.textContent, 
                    formatCurrency(data.reduce((sum, e) => sum + e.advance, 0)),
                    netBalanceEl.textContent
                ]],
                styles: { fontSize: 10, cellPadding: 3, halign: 'center' },
                theme: 'grid',
                headStyles: { fillColor: [0, 51, 102] } // Dark blue header
            });

            // Expense Details Table
            const columns = ["Employee", "Date", "Category", "Description", "Spent (‚Çπ)", "Advance (‚Çπ)", "Net Amount (‚Çπ)"];
            const body = data.map(expense => [
                expense.employeeName || 'N/A',
                expense.date,
                expense.type,
                expense.description,
                expense.amount.toFixed(2),
                expense.advance.toFixed(2),
                (expense.amount - expense.advance).toFixed(2)
            ]);

            const tableY = doc.autoTable.previous.finalY + 15;
            
            doc.setFontSize(14);
            doc.text("Expense Details:", 14, tableY);

            doc.autoTable({
                startY: tableY + 5,
                head: [columns],
                body: body,
                theme: 'striped',
                headStyles: { fillColor: [70, 130, 180] }, // Steel blue
                styles: { fontSize: 8 },
                columnStyles: {
                    4: { halign: 'right' },
                    5: { halign: 'right' },
                    6: { halign: 'right' }
                }
            });

            // Final Footer/Status
            const finalY = doc.autoTable.previous.finalY + 10;
            doc.setFontSize(10);
            doc.text(`Status: ${netBalanceStatus}`, 14, finalY);

            const filter = employeeFilterInput.value.trim() ? `_${employeeFilterInput.value.trim().replace(/\s/g, '-')}` : '_all';
            doc.save(`expense_report${filter}_${new Date().toISOString().slice(0, 10)}.pdf`);
        }

        // --- UI Rendering Functions ---

        /**
         * Renders the month-wise expense summary.
         * @param {object} monthlyTotals - { 'YYYY-MM': totalAmount, ... }
         */
        function renderMonthlySummary(monthlyTotals) {
            monthlySummaryBodyEl.innerHTML = '';
            // Sort by month descending (newest month first)
            const months = Object.keys(monthlyTotals).sort().reverse(); 

            if (months.length === 0) {
                monthlySummaryBodyEl.innerHTML = '<p class="text-gray-500 text-sm italic">No expenses recorded matching the current filter.</p>';
                return;
            }

            months.forEach(monthKey => {
                const total = monthlyTotals[monthKey];
                const [year, monthNum] = monthKey.split('-');
                // Note: JavaScript month index is 0-11, so we use monthNum - 1
                const date = new Date(year, monthNum - 1); 
                const monthName = date.toLocaleString('en-US', { month: 'long', year: 'numeric' });

                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-4 bg-gray-50 rounded-lg shadow-sm border-l-4 border-primary';
                item.innerHTML = `
                    <div class="flex items-center">
                        <span data-lucide="calendar" class="w-5 h-5 mr-3 text-primary"></span>
                        <span class="font-semibold text-gray-800">${monthName}</span>
                    </div>
                    <div class="text-lg font-extrabold text-primary">${formatCurrency(total)}</div>
                `;
                monthlySummaryBodyEl.appendChild(item);
            });
            
            // Re-render icons
            lucide.createIcons();
        }

        /**
         * Renders the list of expenses in the table body.
         * @param {Array<object>} expenses - The filtered list to display.
         */
        function renderExpenses(expenses) {
            expenseListBody.innerHTML = ''; // Clear existing entries

            if (expenses.length === 0) {
                expenseListBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4 text-gray-500 italic">No expenses logged matching the current filter.</td>
                    </tr>
                `;
                return;
            }

            expenses.forEach(expense => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-150 ease-in-out';
                
                // Determine icon and color for category
                let iconName = '';
                let colorClass = '';
                switch(expense.type) {
                    case 'Travel': iconName = 'plane'; colorClass = 'text-blue-500'; break;
                    case 'Food': iconName = 'utensils'; colorClass = 'text-yellow-600'; break;
                    case 'Fuel': iconName = 'gas-station'; colorClass = 'text-red-500'; break;
                    default: iconName = 'tag'; colorClass = 'text-gray-500'; break;
                }

                row.innerHTML = `
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-primary">
                        ${expense.employeeName || 'Unknown'}
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${expense.date}
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="flex items-center">
                            <span data-lucide="${iconName}" class="w-4 h-4 mr-2 ${colorClass}"></span>
                            ${expense.type}
                        </div>
                    </td>
                    <td class="px-3 py-4 text-sm text-gray-500 max-w-xs truncate" title="${expense.description}">
                        ${expense.description}
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-right text-red-600">
                        ${formatCurrency(expense.amount)}
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-right text-green-600">
                        ${formatCurrency(expense.advance || 0)}
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-id="${expense.id}" 
                                class="delete-btn text-red-600 hover:text-red-900 transition duration-150 ease-in-out p-1 rounded-full hover:bg-red-100"
                                title="Delete Expense">
                            <span data-lucide="trash-2" class="w-4 h-4"></span>
                        </button>
                    </td>
                `;
                expenseListBody.appendChild(row);
            });
            
            // Re-render icons after adding content
            lucide.createIcons(); 
        }

        /**
         * Updates the summary cards with calculated totals and net balance.
         * @param {number} totalAmount - Sum of all amounts spent (filtered)
         * @param {number} totalAdvances - Sum of all advances received (filtered)
         * @param {number} entryCount 
         */
        function updateTotals(totalAmount, totalAdvances, entryCount) {
            totalExpensesEl.textContent = formatCurrency(totalAmount);
            totalEntriesEl.textContent = entryCount.toString();
            
            const netBalance = totalAmount - totalAdvances;
            netBalanceEl.textContent = formatCurrency(netBalance);

            // Determine Net Balance styling and status text
            netBalanceCardEl.classList.remove('border-red-500', 'border-green-500', 'border-gray-500');
            netBalanceEl.classList.remove('text-red-600', 'text-green-600', 'text-gray-600');
            netBalanceIconEl.classList.remove('text-red-600', 'text-green-600', 'text-gray-600');

            if (netBalance > 0) {
                // Company owes employee (Employee Payable)
                netBalanceCardEl.classList.add('border-green-500');
                netBalanceEl.classList.add('text-green-600');
                netBalanceIconEl.classList.add('text-green-600');
                netBalanceStatusEl.textContent = 'Net Payable to Employee (Reimbursement Due)';
            } else if (netBalance < 0) {
                // Employee owes company (Employee Refundable)
                netBalanceCardEl.classList.add('border-red-500');
                netBalanceEl.classList.add('text-red-600');
                netBalanceIconEl.classList.add('text-red-600');
                netBalanceStatusEl.textContent = 'Net Refundable to Company (Advance Balance)';
            } else {
                // Balance is 0
                netBalanceCardEl.classList.add('border-gray-500');
                netBalanceEl.classList.add('text-gray-600');
                netBalanceIconEl.classList.add('text-gray-600');
                netBalanceStatusEl.textContent = 'All expenses reconciled.';
            }
            lucide.createIcons();
        }

        // --- Event Listeners ---

        // Form submission handler
        expenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></span> Adding...';
            lucide.createIcons(); 

            const dateInput = document.getElementById('date').value;
            const amountInput = document.getElementById('amount').value;
            const employeeName = employeeNameInput.value.trim();
            
            // Basic validation
            if (!dateInput || !amountInput || parseFloat(amountInput) <= 0 || !employeeName) {
                errorMessageEl.textContent = "Please ensure Employee Name, Date, and a valid positive Amount Spent are provided.";
                errorMessageEl.classList.remove('hidden');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span data-lucide="plus-circle" class="w-5 h-5 mr-2"></span> Add Expense';
                lucide.createIcons(); 
                return;
            }

            const newExpense = {
                employeeName: employeeName,
                type: typeSelect.value,
                date: dateInput,
                amount: amountInput,
                description: document.getElementById('description').value.trim() || 'N/A',
                advance: document.getElementById('advance').value || 0, 
                submittedByUserId: userId // Keep track of who submitted it using the raw Firebase ID
            };

            await addExpense(newExpense);
        });

        // Delete button delegation listener (for dynamically added buttons)
        expenseListBody.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-btn');
            if (deleteButton) {
                const expenseIdToDelete = deleteButton.dataset.id;
                
                // Show modal for confirmation
                confirmModal.classList.remove('hidden');
                confirmModal.classList.add('flex');
                
                // Clear previous listeners and attach new one
                confirmDeleteBtn.onclick = async () => {
                    await deleteExpense(expenseIdToDelete);
                    confirmModal.classList.add('hidden');
                    confirmModal.classList.remove('flex');
                };
            }
        });

        // Modal close listeners
        cancelDeleteBtn.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            confirmModal.classList.remove('flex');
        });
        confirmModal.addEventListener('click', (e) => {
            if (e.target === confirmModal) {
                confirmModal.classList.add('hidden');
                confirmModal.classList.remove('flex');
            }
        });

        // Filter input listener
        employeeFilterInput.addEventListener('input', applyFilterAndRender);
        clearFilterBtn.addEventListener('click', () => {
            employeeFilterInput.value = '';
            applyFilterAndRender();
        });

        // Export button listeners
        exportCsvBtn.addEventListener('click', () => {
            // Export the currently filtered data
            const filterValue = employeeFilterInput.value.trim().toLowerCase();
            const dataToExport = allExpenses.filter(expense => {
                if (!filterValue) return true;
                return expense.employeeName && expense.employeeName.toLowerCase().includes(filterValue);
            });
            exportToCsv(dataToExport);
        });

        exportPdfBtn.addEventListener('click', () => {
            // Export the currently filtered data
            const filterValue = employeeFilterInput.value.trim().toLowerCase();
            const dataToExport = allExpenses.filter(expense => {
                if (!filterValue) return true;
                return expense.employeeName && expense.employeeName.toLowerCase().includes(filterValue);
            });
            exportToPdf(dataToExport);
        });


        // --- Startup ---
        window.onload = function() {
            // Set default date to today for convenience
            document.getElementById('date').valueAsDate = new Date();
            initializeFirebase();
            // Create initial icons
            lucide.createIcons();
        };

    </script>
</body>
</html>